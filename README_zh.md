# 视频压缩工具 - 音质优先版

[English](README.md) | [日本語](README_ja.md)

macOS视频压缩命令行工具。可以指定目标文件大小,在优先保证音质的前提下压缩视频。

## 功能特点

- **精确的大小控制**: 以MB为单位指定目标大小(支持小数)
- **音质优先**: 音频比特率保持在192kbps,确保高音质
- **实时进度显示**: 显示进度条和预计剩余时间
- **2次编码**: 实现高质量压缩
- **批量处理**: 一次处理整个目录中的所有视频
- **模拟运行模式**: 在实际编码前预览压缩结果
- **格式转换**: 支持MP4, MOV, AVI, MKV, WebM, FLV
- **完善的错误处理**: 清晰的错误提示信息

## 系统要求

- macOS
- Python 3.8或更高版本
- ffmpeg

## 安装

### 1. 安装ffmpeg

```bash
brew install ffmpeg
```

### 2. 下载脚本

```bash
# 从GitHub克隆
git clone https://github.com/hiroki-abe-58/video-compressor.git
cd video-compressor

# 或者直接下载
curl -O https://raw.githubusercontent.com/hiroki-abe-58/video-compressor/main/compress_video.py
chmod +x compress_video.py
```

### 3. 授予执行权限

```bash
chmod +x compress_video.py
```

## 使用方法

### 基本用法

```bash
python3 compress_video.py
```

或者:

```bash
./compress_video.py
```

### 命令行选项

```bash
# 普通模式
./compress_video.py

# 模拟运行模式(仅预览不编码)
./compress_video.py --dry-run

# 显示版本
./compress_video.py --version

# 显示帮助
./compress_video.py --help
```

### 执行流程

#### 阶段1: 输入文件路径
```
输入视频文件或目录路径并按回车:
> /path/to/video.mp4
```

**提示**: 也可以从访达拖放文件

#### 阶段2: 输入目标大小
```
文件名: video.mp4
当前文件大小: 150.50 MB
视频时长: 00:05:30

要将此视频压缩到多少MB？输入数字(可以是小数):
> 50
```

#### 阶段3: 格式转换(可选)
```
要转换文件扩展名吗？ (y/直接按回车):
> y

可用格式:
  1. MP4 (H.264)
  2. MOV (QuickTime)
  3. AVI
  4. MKV (Matroska)
  5. WebM
  6. FLV (Flash Video)

选择编号: 1
```

#### 阶段4: 压缩执行
```
[1/2] 第1次: 分析比特率中...
第1次: [████████████████████░░░░░░░░░░░░░░░░░░░░]  48.5% | 剩余时间: 00:02:15

[2/2] 第2次: 最终编码中...
第2次: [████████████████████████████████████████] 100.0% | 剩余时间: 00:00:00
```

#### 阶段5: 完成
```
压缩完成! 压缩后的视频文件已保存。
============================================================
文件名: video--compressed--50.0MB--2025-10-04-15-30-45.mp4
保存位置: /path/to/video--compressed--50.0MB--2025-10-04-15-30-45.mp4
目标大小: 50.00 MB
实际大小: 49.85 MB
差异: 0.15 MB
============================================================

继续压缩另一个视频? (y/n):
```

### 模拟运行模式

在不实际编码的情况下预览压缩结果:

```bash
./compress_video.py --dry-run
```

**输出示例**:
```
模拟运行结果
============================================================
输入文件: video.mp4
当前大小: 150.50 MB
目标大小: 50.00 MB
压缩率: 66.8%
视频时长: 00:05:30

【编码设置】
  视频比特率: 1145 kbps
  音频比特率: 192 kbps (AAC)
  编解码器: H.264 (libx264)

【预计质量】
  高质量 (轻微退化)

【输出文件】
  文件名: video--compressed--50.0MB--2025-10-04-15-30-45.mp4
  保存位置: /path/to/video--compressed--50.0MB--2025-10-04-15-30-45.mp4
============================================================

要实际压缩,请去掉 --dry-run 选项运行。
```

### 批量处理

处理目录中的所有视频文件:

```bash
./compress_video.py

# 输入目录路径
> /Users/username/Videos/batch-compress/

# 找到5个视频文件:
#   1. video1.mp4 (150.50 MB)
#   2. video2.mov (200.30 MB)
#   ...

# 选择设置方式:
#   1. 批量设置 (对所有文件应用相同设置)
#   2. 单独设置 (对每个文件分别配置)
```

## 输出文件格式

```
[原文件名]--compressed--[目标大小]MB--[yyyy-mm-dd-hh-mm-ss].[扩展名]
```

示例:
```
my_video--compressed--50.0MB--2025-10-04-15-30-45.mp4
```

## 错误处理

本工具会检测并清晰显示以下错误:

- 未安装ffmpeg
- 文件不存在
- 不支持的文件格式
- 目标大小大于当前大小
- 目标大小过小(仅音频就超出容量)
- 无效的输入值(非数字等)
- 编码错误

## 技术细节

### 压缩算法

1. **获取视频时长** (使用ffprobe)
2. **将音频比特率固定为192kbps** (保持高质量)
3. **从目标大小计算所需的视频比特率**
   ```
   视频比特率 = (目标大小 - 音频大小) / 视频时长 * 0.95
   ```
4. **使用2次编码进行高质量压缩**
   - 第1次: 分析比特率分配
   - 第2次: 优化编码

### 支持的文件格式

**输入**: `.mp4`, `.avi`, `.mov`, `.mkv`, `.flv`, `.wmv`, `.webm`, `.m4v`, `.mpeg`, `.mpg`

**输出**: `.mp4`, `.mov`, `.avi`, `.mkv`, `.webm`, `.flv`

## 故障排除

### 找不到ffmpeg
```bash
brew install ffmpeg
```

### 压缩耗时过长
- 2次编码需要时间(第1次+第2次)
- 长视频可能需要数十分钟
- 可以通过进度条监控进度

### 目标大小偏差
- ±5%的偏差是正常的
- 如需更精确,可将目标大小设置得稍小一些

### 编码失败
- 检查磁盘空间
- 确认视频文件未损坏
- 尝试其他扩展名

## 许可证

MIT License

## 作者

[hiroki-abe-58](https://github.com/hiroki-abe-58)
