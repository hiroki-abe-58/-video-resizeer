# 動画圧縮ツール - 音質優先版

[English](README.md) | [中文](README_zh.md)

macOS用の動画圧縮CLIツール。目標ファイルサイズを指定して、音質を優先しながら動画を圧縮できます。

## 特徴

- **目標サイズを正確に指定**: MB単位で目標サイズを指定可能(小数点可)
- **音質優先**: 音声ビットレート192kbpsで高音質を維持
- **リアルタイム進捗表示**: プログレスバーと残り時間を表示
- **2パスエンコーディング**: 高品質な圧縮を実現
- **バッチ処理対応**: ディレクトリ内の全動画を一括処理
- **ドライランモード**: 実際の圧縮前に結果をプレビュー
- **拡張子変換対応**: MP4, MOV, AVI, MKV, WebM, FLV
- **わかりやすいエラー表示**: 想定されるエラーを明確に通知

## 必須要件

- macOS
- Python 3.8以上
- ffmpeg

## インストール

### 1. ffmpegのインストール

```bash
brew install ffmpeg
```

### 2. スクリプトのダウンロード

```bash
# GitHubからクローン
git clone https://github.com/hiroki-abe-58/video-compressor.git
cd video-compressor

# または、直接ダウンロード
curl -O https://raw.githubusercontent.com/hiroki-abe-58/video-compressor/main/compress_video.py
chmod +x compress_video.py
```

### 3. 実行権限付与

```bash
chmod +x compress_video.py
```

## 使い方

### 基本的な使い方

```bash
python3 compress_video.py
```

または:

```bash
./compress_video.py
```

### コマンドラインオプション

```bash
# 通常モード
./compress_video.py

# ドライランモード(実際の圧縮はせずプレビューのみ)
./compress_video.py --dry-run

# バージョン表示
./compress_video.py --version

# ヘルプ表示
./compress_video.py --help
```

### 実行フロー

#### フェーズ1: 動画パス入力
```
動画ファイルまたはディレクトリのパスを入力し、エンターを押してください:
> /path/to/video.mp4
```

**ヒント**: ファインダーからドラッグ&ドロップでもOK

#### フェーズ2: 目標サイズ入力
```
ファイル名: video.mp4
現在のファイル容量: 150.50 MB
動画の長さ: 00:05:30

この動画を何MBまで圧縮しますか？数字を入力しエンターを押してください。(小数点可):
> 50
```

#### フェーズ3: 拡張子変換(オプション)
```
拡張子は変換しますか？ (y/何も入力せずEnter):
> y

変換可能な形式:
  1. MP4 (H.264)
  2. MOV (QuickTime)
  3. AVI
  4. MKV (Matroska)
  5. WebM
  6. FLV (Flash Video)

番号を選択してください: 1
```

#### フェーズ4: 圧縮実行
```
[1/2] 1パス目: ビットレート解析中...
1パス目: [████████████████████░░░░░░░░░░░░░░░░░░░░]  48.5% | 残り時間: 00:02:15

[2/2] 2パス目: 最終エンコード中...
2パス目: [████████████████████████████████████████] 100.0% | 残り時間: 00:00:00
```

#### フェーズ5: 完了
```
圧縮が完了し、圧縮した動画ファイルは保存されました!
============================================================
ファイル名: video--compressed--50.0MB--2025-10-04-15-30-45.mp4
保存先: /path/to/video--compressed--50.0MB--2025-10-04-15-30-45.mp4
目標サイズ: 50.00 MB
実際のサイズ: 49.85 MB
差分: 0.15 MB
============================================================

もう1本圧縮する？ (y/n):
```

### ドライランモード

実際の圧縮を行わず、結果をプレビューできます:

```bash
./compress_video.py --dry-run
```

**出力例**:
```
ドライラン結果
============================================================
入力ファイル: video.mp4
現在のサイズ: 150.50 MB
目標サイズ: 50.00 MB
圧縮率: 66.8%
動画の長さ: 00:05:30

【エンコード設定】
  ビデオビットレート: 1145 kbps
  音声ビットレート: 192 kbps (AAC)
  コーデック: H.264 (libx264)

【予想画質】
  高画質 (軽微な劣化)

【出力ファイル】
  ファイル名: video--compressed--50.0MB--2025-10-04-15-30-45.mp4
  保存先: /path/to/video--compressed--50.0MB--2025-10-04-15-30-45.mp4
============================================================

実際に圧縮する場合は --dry-run オプションを外して実行してください。
```

### バッチ処理

ディレクトリ内の全動画ファイルを一括処理:

```bash
./compress_video.py

# ディレクトリパスを入力
> /Users/username/Videos/batch-compress/

# 5個の動画ファイルが見つかりました:
#   1. video1.mp4 (150.50 MB)
#   2. video2.mov (200.30 MB)
#   ...

# 設定方法を選択してください:
#   1. 一括設定 (全てのファイルに同じ設定を適用)
#   2. 個別設定 (ファイルごとに設定)
```

## 出力ファイル名の形式

```
[元ファイル名]--compressed--[目標サイズ]MB--[yyyy-mm-dd-hh-mm-ss].[拡張子]
```

例:
```
my_video--compressed--50.0MB--2025-10-04-15-30-45.mp4
```

## エラーハンドリング

このツールは以下のエラーを検出して、わかりやすく表示します:

- ffmpegが未インストール
- ファイルが存在しない
- サポートされていないファイル形式
- 目標サイズが現在のサイズより大きい
- 目標サイズが小さすぎる(音声だけで容量オーバー)
- 無効な入力値(数字以外など)
- エンコード中のエラー

## 技術詳細

### 圧縮アルゴリズム

1. **動画の長さを取得** (ffprobe使用)
2. **音声ビットレートを192kbpsに固定** (高音質維持)
3. **目標サイズから必要なビデオビットレートを逆算**
   ```
   ビデオビットレート = (目標サイズ - 音声サイズ) / 動画の長さ * 0.95
   ```
4. **2パスエンコーディングで高品質圧縮**
   - 1パス目: ビットレート配分を解析
   - 2パス目: 最適化されたエンコーディング

### サポートファイル形式

**入力**: `.mp4`, `.avi`, `.mov`, `.mkv`, `.flv`, `.wmv`, `.webm`, `.m4v`, `.mpeg`, `.mpg`

**出力**: `.mp4`, `.mov`, `.avi`, `.mkv`, `.webm`, `.flv`

## トラブルシューティング

### ffmpegが見つからない
```bash
brew install ffmpeg
```

### 圧縮に時間がかかりすぎる
- 2パスエンコーディングは時間がかかる(1パス目+2パス目)
- 長い動画だと数十分かかることもある
- プログレスバーで進捗確認できる

### 目標サイズとずれる
- ±5%程度の誤差は正常
- より正確にしたい場合は、目標サイズを少し小さめに設定

### エンコードが失敗する
- ディスク容量を確認
- 動画ファイルが壊れていないか確認
- 別の拡張子で試す

## ライセンス

MIT License

## 作者

[hiroki-abe-58](https://github.com/hiroki-abe-58)

## 謝辞

参考: https://note.com/genelab_999/n/n5db5c3a80793
